language: generic
node_js:
  - 14

services:
  - docker

before_install:
  - docker build -t $DOCKER_USERNAME/$API_NAME -f ./server/Dockerfile ./server
  - docker build -t $DOCKER_USERNAME/$INT_NAME -f ./server/Dockerfile.test ./server


before_script:
  - docker network create $NETWORK_NAME
  - sleep 5
  - >-
    docker run -d
    --network $NETWORK_NAME
    --env PORT=$API_PORT
    --env CI=true
    --name $API_NAME
    $DOCKER_USERNAME/$API_NAME

script:
  - docker ps -a
  - >-
    docker run
    --network $NETWORK_NAME
    --env API_HOST=$API_NAME
    --env MONGO=$MONGO
    --env PORT=$API_PORT
    $DOCKER_USERNAME/$INT_NAME

after_success:
  - docker build -t $DOCKER_USERNAME/tamashii-client ./client
  - docker build -t $DOCKER_USERNAME/tamashii-nginx ./nginx
  - docker build -t $DOCKER_USERNAME/tamashii-server ./server
  # Login into the Docker CLI
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  # Push to DockerHUB
  - docker push $DOCKER_USERNAME/tamashii-client
  - docker push $DOCKER_USERNAME/tamashii-nginx
  - docker push $DOCKER_USERNAME/tamashii-server
